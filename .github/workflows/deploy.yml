# Example deploy workflow for application repositories.
#
# Copy this file to .github/workflows/deploy.yml in your application repo and
# replace APP_NAME_HERE with the application name (e.g., gatus, noko-lsm).
#
# Required secret (set as an organization secret or per-repo):
#   OPS_DEPLOY_TOKEN - A GitHub token with permission to send repository_dispatch
#                      events to the Lullabot/ops repository.

name: Deploy to Lullabot server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-24.04
    steps:
      - name: Trigger deployment via ops repo
        env:
          GH_TOKEN: ${{ secrets.OPS_DEPLOY_TOKEN }}
        run: |
          gh api \
            --method POST \
            /repos/Lullabot/ops/dispatches \
            -f "event_type=deploy" \
            -f "client_payload[app]=slackbot" \
            -f "client_payload[trigger_id]=${{ github.run_id }}"

      - name: Find deploy workflow run
        env:
          GH_TOKEN: ${{ secrets.OPS_DEPLOY_TOKEN }}
        run: |
          echo "Waiting for deploy workflow to start..."
          for i in $(seq 1 30); do
            RUN_URL=$(gh api \
              "/repos/Lullabot/ops/actions/runs?event=repository_dispatch&per_page=10" \
              --jq ".workflow_runs[] | select(.name | contains(\"${{ github.run_id }}\")) | .html_url" \
            )
            if [[ -n "${RUN_URL}" ]]; then
              echo "Deploy workflow started:"
              echo "  ${RUN_URL}"
              echo ""
              echo "::notice::Deploy workflow: ${RUN_URL}"
              exit 0
            fi
            sleep 2
          done

          echo "::warning::Could not find deploy workflow run. Check the ops repo Actions tab manually."
